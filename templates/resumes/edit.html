{% extends "base.html" %}
{% block content %}

<div class="max-w-4xl mx-auto mt-10 bg-white p-8 rounded-lg shadow">
    <h1 class="text-2xl font-bold mb-6">Edit Resume</h1>

    <!-- ✅ FORM -->
    <form method="post" onsubmit="beforeSubmit()">
        {% csrf_token %}

        <!-- Full Name -->
        <div class="mb-4">
            <label class="block font-semibold mb-1">Full Name</label>
            <input type="text" name="full_name" value="{{ resume.full_name }}"
                   class="w-full border px-3 py-2 rounded">
        </div>

        <!-- Email -->
        <div class="mb-4">
            <label class="block font-semibold mb-1">Email</label>
            <input type="email" name="email" value="{{ resume.email }}"
                   class="w-full border px-3 py-2 rounded">
        </div>

        <!-- Phone -->
        <div class="mb-4">
            <label class="block font-semibold mb-1">Phone</label>
            <input type="text" name="phone" value="{{ resume.phone }}"
                   class="w-full border px-3 py-2 rounded">
        </div>

        <!-- SUMMARY -->
        <div class="mb-6">
            <label class="block font-semibold mb-1">Professional Summary</label>
            <textarea id="summary" name="summary">{{ resume.summary }}</textarea>

            <button type="button"
                    onclick="improveText('summary')"
                    class="mt-3 bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                ✨ Improve Summary
            </button>
        </div>

        <!-- SKILLS -->
        <div class="mb-6 relative">
            <label class="block font-semibold mb-2">Skills</label>

            <input type="text" id="skillInput" placeholder="Add a skill"
                   class="w-full border px-3 py-2 rounded">

            <div id="skillList" class="flex flex-wrap gap-2 mt-3"></div>

            <div id="aiSuggestions" class="mt-4 hidden">
                <p class="text-sm font-semibold text-gray-600 mb-2">Suggested by AI</p>
                <div id="aiSkillList" class="flex flex-wrap gap-2"></div>
            </div>

            <input type="hidden" name="skills" id="skillsField" value="{{ resume.skills }}">
        </div>

        <!-- EXPERIENCE -->
        <div class="mb-6">
            <label class="block font-semibold mb-1">Experience</label>
            <textarea id="experience" name="experience">{{ resume.experience }}</textarea>

            <button type="button"
                    onclick="improveText('experience')"
                    class="mt-3 bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                ✨ Rewrite Experience
            </button>
        </div>

        <!-- EDUCATION -->
        <div class="mb-6">
            <label class="block font-semibold mb-1">Education</label>
            <textarea id="education" name="education">{{ resume.education }}</textarea>

            <button type="button"
                    onclick="improveText('education')"
                    class="mt-3 bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                ✨ Improve Education
            </button>
        </div>

        <!-- ACTION BUTTONS -->
        <div class="flex justify-end gap-4 mt-6">
            <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded">
                Save & Preview
            </button>
            <a href="{% url 'resumes:resume_preview' resume.id %}"
               class="bg-blue-600 text-white px-6 py-2 rounded">
                Preview Resume
            </a>
        </div>
    </form>
</div>

<!-- CKEDITOR -->
<script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>
<script>
['summary','experience','education'].forEach(id=>{
    CKEDITOR.replace(id,{height:150});
});
function syncEditors(){
    for (let i in CKEDITOR.instances) {
        CKEDITOR.instances[i].updateElement();
    }
}
</script>

<!-- ✅ AI TEXT IMPROVE LOGIC -->
<script>
function improveText(fieldName) {

    const editor = CKEDITOR.instances[fieldName];
    const text = editor ? editor.getData() : document.getElementById(fieldName).value;

    const csrfToken = document.querySelector(
        'input[name="csrfmiddlewaretoken"]'
    ).value;

    fetch("/ai/improve/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({
            text: text,
            field: fieldName
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.result) {
            if (editor) editor.setData(data.result);
            else document.getElementById(fieldName).value = data.result;
        } else {
            alert("AI Error");
        }
    })
    .catch(()=>alert("AI request failed"));
}
</script>

<!-- ✅ LINKEDIN-STYLE SKILLS SCRIPT -->
<script>
let skills = [];

const skillInput = document.getElementById("skillInput");
const skillList = document.getElementById("skillList");
const skillsField = document.getElementById("skillsField");
const aiBox = document.getElementById("aiSuggestions");
const aiSkillList = document.getElementById("aiSkillList");

// Load existing skills
if (skillsField.value) {
    skillsField.value.split(",").forEach(s => addSkill(s.trim()));
}

// Add skill
function addSkill(skill) {
    if (!skill || skills.includes(skill)) return;
    skills.push(skill);

    const tag = document.createElement("span");
    tag.className = "bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm flex items-center gap-2";
    tag.innerHTML = `${skill} <button type="button" class="text-red-500">&times;</button>`;

    tag.querySelector("button").onclick = () => {
        skills = skills.filter(s => s !== skill);
        tag.remove();
        updateSkillsField();
    };

    skillList.appendChild(tag);
    updateSkillsField();
}

// Update hidden field
function updateSkillsField() {
    skillsField.value = skills.join(",");
}

// Input handling
skillInput.addEventListener("keydown", e => {
    if (e.key === "Enter" || e.key === ",") {
        e.preventDefault();
        addSkill(skillInput.value.trim());
        skillInput.value = "";
    }
});

// AI skill suggestion
skillInput.addEventListener("focus", () => {
    fetch("/ai/skills/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector('input[name="csrfmiddlewaretoken"]').value
        },
        body: JSON.stringify({
            summary: CKEDITOR.instances.summary.getData(),
            experience: CKEDITOR.instances.experience.getData()
        })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.skills) return;
        aiSkillList.innerHTML = "";
        aiBox.classList.remove("hidden");

        data.skills.forEach(skill => {
            if (skills.includes(skill)) return;
            const chip = document.createElement("span");
            chip.className = "bg-gray-200 px-3 py-1 rounded-full text-sm cursor-pointer hover:bg-gray-300";
            chip.innerText = skill;
            chip.onclick = () => addSkill(skill);
            aiSkillList.appendChild(chip);
        });
    });
});

// Sync before submit
function beforeSubmit() {
    syncEditors();
    updateSkillsField();
}
</script>

{% endblock %}
