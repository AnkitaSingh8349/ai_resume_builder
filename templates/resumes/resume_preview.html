{% extends "base.html" %}
{% block title %}Choose Resume Template{% endblock %}

{% block content %}

<!-- ================= PAGE HEADER ================= -->
<section class="max-w-7xl mx-auto px-4 py-6">
  <h1 class="text-3xl font-bold text-gray-900 text-center">
    Templates we recommend for you
  </h1>
  <p class="text-center text-gray-500 mt-2">
    You can always change your template later.
  </p>
</section>

<!-- ================= MAIN CONTENT ================= -->
<section class="max-w-7xl mx-auto px-4 pb-10">

  <div class="grid grid-cols-1 lg:grid-cols-[340px_1fr] gap-8">

    <!-- ================= LEFT PANEL ================= -->
    <aside class="bg-white rounded-2xl shadow-sm border p-5
                  lg:sticky lg:top-24 h-fit">

      <h2 class="text-lg font-semibold mb-4 text-gray-800">
        Choose Template
      </h2>

      <div class="space-y-3">

        <a href="?template=modern"
           class="block px-4 py-3 rounded-xl border
           {% if active == 'modern' %} bg-indigo-600 text-white {% endif %}">
          Modern
        </a>

        <a href="?template=professional"
           class="block px-4 py-3 rounded-xl border
           {% if active == 'professional' %} bg-indigo-600 text-white {% endif %}">
          Professional
        </a>

        <a href="?template=simple"
           class="block px-4 py-3 rounded-xl border
           {% if active == 'simple' %} bg-indigo-600 text-white {% endif %}">
          Simple
        </a>

        <div class="pt-3 border-t"></div>

        <a href="?template=creative"
           class="block px-4 py-3 rounded-xl border
           {% if active == 'creative' %} bg-purple-600 text-white {% endif %}">
          Creative (Premium)
        </a>

        <a href="?template=executive"
           class="block px-4 py-3 rounded-xl border
           {% if active == 'executive' %} bg-purple-600 text-white {% endif %}">
          Executive (Premium)
        </a>

        <a href="?template=minimalist"
           class="block px-4 py-3 rounded-xl border
           {% if active == 'minimalist' %} bg-purple-600 text-white {% endif %}">
          Minimalist (Premium)
        </a>

      </div>

      {% if active in free_templates %}
        <button onclick="downloadResumePDF()"
                class="mt-6 w-full bg-green-600 text-white py-3 rounded-xl">
          Download PDF
        </button>
      {% else %}
        <a href="{% url 'resumes:checkout' %}?resume_id={{ resume.id }}&template={{ active }}"
           class="mt-6 block text-center bg-purple-600 text-white py-3 rounded-xl">
          Unlock Premium
        </a>
      {% endif %}

    </aside>

    <!-- ================= RIGHT PREVIEW ================= -->
    <main class="bg-white rounded-2xl border shadow-sm p-6 md:p-10">

      <p class="text-sm text-gray-500 uppercase tracking-wide mb-6">
        Resume Preview
      </p>

      <!-- âœ… ONLY THIS DIV WILL GO TO PDF -->
      <div id="resume-preview" class="mx-auto bg-white">
        {% include active_template %}
      </div>

    </main>

  </div>

</section>

<!-- ================= html2pdf ================= -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- ================= FINAL FIXED PDF FUNCTION ================= -->
<script>
function downloadResumePDF() {

  const element = document.getElementById("resume-preview");

  // ðŸ”¥ FORCE SCROLL TO TOP (MAIN FIX)
  window.scrollTo(0, 0);

  const pxToMm = px => px * 0.264583;
  const heightMm = pxToMm(element.scrollHeight);

  html2pdf()
    .set({
      filename: "{{ resume.full_name|default:'resume' }}.pdf",
      margin: [0, 0, 0, 0],
      image: { type: "jpeg", quality: 1 },
      html2canvas: {
        scale: 2,
        scrollX: 0,
        scrollY: -window.scrollY,   // ðŸ”¥ KILLS TOP WHITE SPACE
        backgroundColor: "#ffffff"
      },
      jsPDF: {
        unit: "mm",
        format: [210, heightMm],    // âœ… AUTO HEIGHT = jitna data utna page
        orientation: "portrait"
      }
    })
    .from(element)
    .save();
}
</script>

{% endblock %}
